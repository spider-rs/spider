name: Rust
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPEN_ROUTER: ${{ secrets.OPEN_ROUTER }}
      SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
      RUN_LIVE_TESTS: ${{ secrets.RUN_LIVE_TESTS }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/cache@v3
        id: cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Cargo check workspace
        run: cargo check --workspace
      - name: Cargo test spider_agent (default)
        run: cargo test -p spider_agent
      - name: Cargo test spider_agent (openai + search_serper)
        run: cargo test -p spider_agent --features "openai search_serper"
      - name: Cargo test spider_agent live smoke
        if: env.RUN_LIVE_TESTS == '1' || env.RUN_LIVE_TESTS == 'true' || env.RUN_LIVE_TESTS == 'TRUE'
        run: cargo test -p spider_agent --features "openai search_serper" --test live_env_smoke -- --nocapture
